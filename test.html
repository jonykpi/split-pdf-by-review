<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF Preview with Blank Page Insert</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 10px; 
      max-width: 1200px; 
      margin: 0 auto; 
      background-color: #f5f5f5;
    }
    h2 { 
      text-align: center; 
      margin-bottom: 15px; 
      color: #333;
      font-size: 1.5em;
    }
    #fileInput { 
      display: block; 
      margin: 0 auto 20px auto; 
      padding: 8px 12px;
      border: 2px dashed #ccc;
      border-radius: 5px;
      background: white;
      cursor: pointer;
    }
    #preview { 
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 15px; 
      padding: 10px;
    }
    .page-container { 
      border: 1px solid #ddd; 
      padding: 8px; 
      position: relative; 
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      max-width: 350px;
      margin: 0 auto;
    }
    .page-container > div:first-child {
      font-weight: bold;
      margin-bottom: 8px;
      color: #555;
      font-size: 0.9em;
    }
    .page-controls { 
      margin-top: 8px; 
      text-align: center;
    }
    .page-controls button {
      background: #007bff;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .page-controls button:hover {
      background: #0056b3;
    }
    canvas { 
      border: 1px solid #ccc; 
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    
    @media (max-width: 1200px) {
      #preview {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      #preview {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      #preview {
        grid-template-columns: 1fr;
      }
      .page-container {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <h2>PDF Preview with Blank Page Insert</h2>
  <input type="file" id="fileInput" accept="application/pdf"><br><br>
  <div style="text-align: center; margin-bottom: 20px;">
    <button id="saveBtn" style="display: none; background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">
      ðŸ’¾ Download Modified PDF
    </button>
  </div>
  <div id="preview"></div>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("preview");
    const saveBtn = document.getElementById("saveBtn");
    let pdfDoc = null;
    let pages = []; // store page info (original + blanks)
    let originalPdfBytes = null;
    let modifiedPdfDoc = null;

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function(event) {
        const typedarray = new Uint8Array(event.target.result);
        originalPdfBytes = typedarray;
        await renderPDF(typedarray);
        saveBtn.style.display = 'inline-block';
      };
      reader.readAsArrayBuffer(file);
    });

    async function renderPDF(data) {
      preview.innerHTML = "";
      pages = [];

      // Load with PDF.js for rendering
      pdfDoc = await pdfjsLib.getDocument({data}).promise;
      
      // Load with pdf-lib for manipulation
      modifiedPdfDoc = await PDFLib.PDFDocument.load(data);

      for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        const page = await pdfDoc.getPage(pageNum);

        const viewport = page.getViewport({scale: 0.8});
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({canvasContext: context, viewport}).promise;

        addPageToPreview(canvas, pageNum, false, pageNum - 1);
      }
    }

    function addPageToPreview(canvas, pageNum, isBlank = false, pdfPageIndex = null) {
      const wrapper = document.createElement("div");
      wrapper.className = "page-container";

      const label = document.createElement("div");
      label.textContent = isBlank ? `Blank Page (after ${pageNum-1})` : `Page ${pageNum}`;
      wrapper.appendChild(label);

      wrapper.appendChild(canvas);

      const controls = document.createElement("div");
      controls.className = "page-controls";

      const btn = document.createElement("button");
      btn.textContent = `Add blank page after this`;
      btn.onclick = () => insertBlankPage(wrapper, canvas.width, canvas.height);
      controls.appendChild(btn);

      wrapper.appendChild(controls);
      preview.appendChild(wrapper);

      pages.push({
        canvas, 
        isBlank, 
        pageNum, 
        pdfPageIndex: pdfPageIndex !== null ? pdfPageIndex : pages.length,
        wrapper
      });
    }

    function insertBlankPage(afterWrapper, width, height) {
      const blankCanvas = document.createElement("canvas");
      blankCanvas.width = width;
      blankCanvas.height = height;

      const ctx = blankCanvas.getContext("2d");
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, width, height);

      const wrapper = document.createElement("div");
      wrapper.className = "page-container";
      wrapper.innerHTML = "<div>Blank Page</div>";
      wrapper.appendChild(blankCanvas);

      preview.insertBefore(wrapper, afterWrapper.nextSibling);
      
      // Find the correct position to insert the blank page
      const afterIndex = Array.from(preview.children).indexOf(afterWrapper);
      const insertIndex = afterIndex + 1;
      
      // Create the blank page object
      const blankPage = {
        canvas: blankCanvas, 
        isBlank: true, 
        pageNum: insertIndex + 1,
        pdfPageIndex: null,
        wrapper
      };
      
      // Insert at the correct position in the pages array
      pages.splice(insertIndex, 0, blankPage);
      
      // Update page numbers for all pages after the insertion
      for (let i = insertIndex + 1; i < pages.length; i++) {
        pages[i].pageNum = i + 1;
      }
    }

    // Save button functionality
    saveBtn.addEventListener("click", async () => {
      if (!originalPdfBytes || pages.length === 0) return;
      
      try {
        // Create a new PDF document
        const newPdfDoc = await PDFLib.PDFDocument.create();
        
        // Get the original PDF document
        const originalPdfDoc = await PDFLib.PDFDocument.load(originalPdfBytes);
        
        // Get dimensions from first original page
        const firstOriginalPage = originalPdfDoc.getPage(0);
        const { width, height } = firstOriginalPage.getSize();
        
        // Process each page in the exact order as displayed
        for (let i = 0; i < pages.length; i++) {
          const pageInfo = pages[i];
          
          if (pageInfo.isBlank) {
            // Create a blank page with the same dimensions
            const blankPage = newPdfDoc.addPage([width, height]);
            // The page is already white by default
            
          } else {
            // Copy the original page from the source PDF
            // Use the pdfPageIndex to get the correct original page
            const [copiedPage] = await newPdfDoc.copyPages(originalPdfDoc, [pageInfo.pdfPageIndex]);
            newPdfDoc.addPage(copiedPage);
          }
        }
        
        // Save the PDF
        const pdfBytes = await newPdfDoc.save();
        
        // Create download link
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        const fileName = fileInput.files[0]?.name?.replace('.pdf', '') || 'modified_pdf';
        link.download = `${fileName}_with_blank_pages.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up
        URL.revokeObjectURL(url);
        
        console.log('PDF generated with pages in order:', pages.map(p => p.isBlank ? 'Blank' : `Page ${p.pdfPageIndex + 1}`));
        
      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Error generating PDF. Please try again.');
      }
    });
  </script>
</body>
</html>
